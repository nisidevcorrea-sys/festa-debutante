{% extends "base.html" %}

{% block title %}Gerenciar Convidados - Admin{% endblock %}

{% block content %}
<section class="admin-guests py-5">
    <div class="container-fluid pt-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="display-6">
                    <i class="fas fa-user-friends"></i> Gerenciar Convidados
                </h1>
                <p class="text-muted">Adicione, edite ou remova convidados da lista</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGuestModal">
                    <i class="fas fa-plus"></i> Adicionar Convidado
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="filterName" 
                            placeholder="Buscar por nome..."
                        >
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterStatus">
                            <option value="">Todos os Status</option>
                            <option value="confirmado">Confirmado</option>
                            <option value="pendente">Pendente</option>
                            <option value="nao_confirmado">Não Confirmado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterGroup">
                            <option value="">Todos os Grupos</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.group_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guests Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="guestsTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>Email</th>
                                <th>Grupo</th>
                                <th>Status</th>
                                <th>Acompanhante</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for guest in guests %}
                            <tr data-status="{{ guest.status }}" data-group="{{ guest.group_id or '' }}">
                                <td><strong>{{ guest.name }}</strong></td>
                                <td>{{ guest.phone or '-' }}</td>
                                <td>{{ guest.email or '-' }}</td>
                                <td>
                                    {% if guest.group %}
                                    <span class="badge bg-info">{{ guest.group.group_name }}</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if guest.status == 'confirmado' %}
                                    <span class="badge bg-success">Confirmado</span>
                                    {% elif guest.status == 'nao_confirmado' %}
                                    <span class="badge bg-danger">Não Confirmado</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">Pendente</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if guest.plus_one %}
                                    <i class="fas fa-check text-success"></i>
                                    {% else %}
                                    <i class="fas fa-times text-danger"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editGuest({{ guest.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteGuest({{ guest.id }}, '{{ guest.name }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add Guest Modal -->
<div class="modal fade" id="addGuestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus"></i> Adicionar Convidado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addGuestForm">
                    <div class="mb-3">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telefone</label>
                        <input type="tel" class="form-control" name="phone" placeholder="+55 11 99999-9999">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Grupo/Família</label>
                        <select class="form-select" name="group_id">
                            <option value="">Sem grupo</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.group_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="plus_one" id="plusOne">
                            <label class="form-check-label" for="plusOne">
                                Pode levar acompanhante
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveGuest()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filter guests
$('#filterName, #filterStatus, #filterGroup').on('input change', function() {
    const name = $('#filterName').val().toLowerCase();
    const status = $('#filterStatus').val();
    const group = $('#filterGroup').val();
    
    $('#guestsTable tbody tr').each(function() {
        const $row = $(this);
        const rowName = $row.find('td:first').text().toLowerCase();
        const rowStatus = $row.data('status');
        const rowGroup = $row.data('group').toString();
        
        let show = true;
        
        if (name && !rowName.includes(name)) {
            show = false;
        }
        
        if (status && rowStatus !== status) {
            show = false;
        }
        
        if (group && rowGroup !== group) {
            show = false;
        }
        
        $row.toggle(show);
    });
});

function clearFilters() {
    $('#filterName, #filterStatus, #filterGroup').val('');
    $('#guestsTable tbody tr').show();
}

function saveGuest() {
    const formData = new FormData($('#addGuestForm')[0]);
    const data = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        group_id: formData.get('group_id') || null,
        plus_one: formData.get('plus_one') === 'on',
        notes: formData.get('notes')
    };
    
    $.ajax({
        url: '/api/admin/guest',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                alert('Convidado adicionado com sucesso!');
                location.reload();
            }
        },
        error: function() {
            alert('Erro ao adicionar convidado');
        }
    });
}

function deleteGuest(guestId, guestName) {
    if (!confirm(`Tem certeza que deseja remover ${guestName}?`)) {
        return;
    }
    
    $.ajax({
        url: `/api/admin/guest/${guestId}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                alert('Convidado removido com sucesso!');
                location.reload();
            }
        },
        error: function() {
            alert('Erro ao remover convidado');
        }
    });
}

function editGuest(guestId) {
    // Implementar modal de edição
    alert('Funcionalidade de edição em desenvolvimento');
}
</script>

<style>
.admin-guests {
    min-height: 100vh;
    background: #f8f9fa;
}

.table tbody tr {
    cursor: pointer;
    transition: all 0.3s;
}

.table tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.1);
}
</style>
{% endblock %}
